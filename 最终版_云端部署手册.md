# AI 助手云端部署全流程手册 (最终版)

本文档是针对腾讯云服务器部署 AI 助手服务端的完整操作指南。请严格按照步骤执行。

---

## 1. 准备部署包 (本地操作)

在开始部署前，请确保本地已经生成了最新的服务端部署包。

1.  **运行打包脚本**：
    在项目根目录下打开终端，运行：
    ```powershell
    python prepare_server_package.py
    ```
    *成功提示*：`Server package created successfully at: ...\server_dist`

2.  **检查 `server_dist` 目录**：
    确保该目录下包含：
    *   `core/`, `ai_tools/`, `ai_konwledge/` 等核心文件夹。
    *   `server_app.py` (这是新的服务端入口)。
    *   `requirements.txt` (依赖列表)。
    *   `start.sh` (Linux 启动脚本)。
    *   `config.json` (配置文件)。

---

## 2. 上传文件到云服务器

假设你的云服务器 IP 为 `1.2.3.4` (请替换为实际 IP)，用户名为 `ubuntu` (或 `root`)。

1.  **上传 `server_dist` 文件夹**：
    使用 SCP 命令将整个文件夹上传到服务器的 `/opt/` 目录（或其他你喜欢的目录）。

    ```powershell
    # 在本地终端执行 (替换你的 IP 和用户名)
    scp -r server_dist ubuntu@1.2.3.4:/home/ubuntu/
    ```
    *(如果是 Windows 服务器，请使用远程桌面复制粘贴，或 FTP 工具)*

2.  **登录服务器**：
    ```powershell
    ssh ubuntu@1.2.3.4
    ```

---

## 3. 服务器环境配置 (云端操作)

登录服务器后，执行以下命令。以 Ubuntu/Linux 为例。

### 3.1 移动与权限
将上传的文件夹移动到标准位置（可选），并进入目录：
```bash
sudo mv /home/ubuntu/server_dist /opt/ai_assistant_server
cd /opt/ai_assistant_server
```

### 3.2 安装 Python 3.10+
确保 Python 版本正确。
```bash
python3 --version
# 如果版本低于 3.10，请安装：
sudo apt update
sudo apt install python3.10 python3.10-venv python3-pip
```

### 3.3 创建虚拟环境 (强烈推荐)
为了避免污染系统环境，请创建虚拟环境：
```bash
# 创建名为 venv 的虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```
*(激活后，终端提示符前会显示 `(venv)`)*

### 3.4 安装依赖库
```bash
pip install -r requirements.txt
```
*注意：如果报错缺少某些系统库（如 libGL），可能需要安装：*
```bash
sudo apt install libgl1-mesa-glx
```

### 3.5 修改配置文件
使用 `nano` 或 `vim` 编辑 `config.json`：
```bash
nano config.json
```
**关键检查点**：
*   `server.host`: 必须是 `"0.0.0.0"` (允许公网访问)。
*   `server.port`: 默认 `8000`。
*   `llm.api_key`: 确保云端也填入了有效的 API Key。
*   `auth_token`: 建议设置一个复杂的密码，例如 `"my_secret_token_2024"`。

---

## 4. 启动服务

### 4.1 临时测试运行
先手动启动，观察是否有报错：
```bash
# 确保在 venv 下
python server_app.py
```
*成功标志*：看到 `Uvicorn running on http://0.0.0.0:8000`。
按 `Ctrl+C` 停止。

### 4.2 后台常驻运行 (Systemd)
为了让服务在关闭 SSH 后持续运行，并开机自启：

1.  **创建服务文件**：
    ```bash
    sudo nano /etc/systemd/system/ai_assistant.service
    ```

2.  **填入内容** (注意路径是否匹配)：
    ```ini
    [Unit]
    Description=AI Assistant Server
    After=network.target

    [Service]
    User=root
    # 或者 User=ubuntu，取决于你用哪个用户运行
    WorkingDirectory=/opt/ai_assistant_server
    # 注意：这里要用虚拟环境里的 python
    ExecStart=/opt/ai_assistant_server/venv/bin/python /opt/ai_assistant_server/server_app.py
    Restart=always
    RestartSec=5

    [Install]
    WantedBy=multi-user.target
    ```

3.  **启用并启动**：
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable ai_assistant
    sudo systemctl start ai_assistant
    ```

4.  **查看状态**：
    ```bash
    sudo systemctl status ai_assistant
    ```
    *(应显示 `active (running)`)*

### 4.3 开放防火墙端口
确保腾讯云控制台的 **安全组** 规则中，入站规则已放行 **TCP 8000** 端口。
如果在服务器内部开启了 `ufw`，也需要放行：
```bash
sudo ufw allow 8000/tcp
```

---

## 5. 本地客户端配置 (本地操作)

回到你的本地电脑。

1.  **打开配置文件**：
    打开项目根目录下的 `config.json`。

2.  **修改 Server 配置**：
    ```json
    "server": {
        "host": "1.2.3.4",   // 替换为云服务器公网 IP
        "port": 8000,
        "auth_token": "my_secret_token_2024" // 必须与服务器 config.json 一致
    }
    ```

3.  **启动客户端**：
    运行 `ui_main.py` 启动桌面助手。

4.  **连接测试**：
    *   在聊天界面顶部，**勾选“云端模式”**。
    *   发送消息：“你好，云端大脑”。
    *   如果收到回复，恭喜你！部署成功。
    *   *此时，你的本地电脑只负责显示，所有思考都在云端完成。即使关闭本地程序，云端服务依然在线。*

---

## 6. 额外功能：Web 远程访问

部署成功后，你还可以直接通过浏览器访问云端助手（无需本地客户端）：

*   **地址**：`http://1.2.3.4:8000/`
*   **功能**：这是一个简易的 Web 聊天界面，直接连接云端大脑。你可以用手机随时随地与它对话。
