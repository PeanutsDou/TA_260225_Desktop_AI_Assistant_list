# 云端部署开发流程文档

## 1. 项目概述
本项目旨在将现有的桌面 AI 助手（Brain + Memory）部署到腾讯云服务器，实现 24 小时在线待命。同时，保留本地完整运行能力，支持在“云端模式”和“本地模式”之间切换。

### 核心目标
1.  **云端 24h 运行**：Agent 大脑、记忆（Memory）、技能（Skills）在云端服务器运行。
2.  **本地/云端切换**：本地客户端（UI）可以选择连接云端大脑，或使用本地大脑。
3.  **数据同步**：保证云端和本地的记忆文件（`core_chat_memory.json` 等）保持一致（或提供同步机制）。

## 2. 架构设计建议

### 2.1 整体架构
采用 **C/S (Client-Server)** 架构：

*   **服务端 (Cloud Server)**：
    *   **核心组件**：部署 `core/` (Agent核心), `ai_tools/` (工具集), `ai_konwledge/` (知识库), `config.json` (配置文件), `.remote_chat/server/` (服务端入口)。
    *   **运行方式**：使用 FastAPI + WebSocket 服务，监听客户端连接。
    *   **持久化**：数据文件（如 `history_data.json`, `core_chat_memory.json`）存储在服务器本地磁盘。
    *   **进程守护**：使用 `systemd` 或 Docker 容器确保进程崩溃后自动重启。

*   **客户端 (Local Client)**：
    *   **核心组件**：`ui/` (界面), `.remote_chat/client/` (连接模块), 以及完整的本地代码副本。
    *   **双模式切换**：
        *   **本地模式**：直接实例化本地 `AgentSession`，读取本地文件。
        *   **云端模式**：通过 WebSocket 连接云端，发送用户输入，接收流式响应。

### 2.2 数据同步方案 (关键)
为了满足“本地也要保留完整内容”且“可切换”的要求，需要解决数据一致性问题。建议以 **云端为主，本地为辅** 的策略：

1.  **启动同步**：每次启动客户端连接云端时，检查云端记忆文件的最后修改时间。如果云端较新，提示用户或自动拉取云端记忆覆盖本地。
2.  **手动同步**：在 UI 设置中增加“上传本地记忆到云端”和“从云端下载记忆”的按钮。
3.  **文件清单**：需要同步的核心文件包括：
    *   `core/core_data/core_chat_memory.json` (对话短期记忆)
    *   `history_data/history_data.json` (历史记录)
    *   `ai_konwledge/` 下的知识库配置 (如果经常变动)

## 3. 开发流程 (Step-by-Step)

### 第一阶段：环境准备 (Server)
1.  **服务器环境**：
    *   系统：Ubuntu/CentOS (推荐 Linux) 或 Windows Server (如果必须)。
    *   Python：安装 Python 3.10+。
    *   依赖管理：导出 `requirements.txt` 并安装。
2.  **代码同步**：
    *   使用 Git 或 SCP 将除 `ui/` 和 `__pycache__/` 外的核心代码上传至服务器 `/opt/ai_assistant/` (示例路径)。

### 第二阶段：服务端改造 (Server Code)
1.  **完善 `server_app.py`**：
    *   目前 `server_app.py` 仅是基础框架。需要导入 `core.core_agent.Agent.AgentSession`。
    *   在 WebSocket 连接建立时，初始化 `AgentSession`。
    *   接收客户端消息 -> 调用 `agent.chat(msg, stream=True)` -> 将生成器结果通过 WebSocket 推送回客户端。
2.  **API 扩展**：
    *   新增 HTTP 接口 `/sync/upload` 和 `/sync/download`，用于传输 JSON 记忆文件。
3.  **配置分离**：
    *   服务器端的 `config.json` 应配置为服务器环境（如 API Key，监听端口 0.0.0.0）。

### 第三阶段：客户端改造 (Client Code)
1.  **增强 `RemoteClient`**：
    *   在 `.remote_chat/client/client_app.py` 中增加文件上传/下载的方法，调用服务端的 Sync API。
2.  **UI 适配**：
    *   在 `ui_settings.py` 或主界面增加“模式切换”开关。
    *   在切换到“云端模式”时，初始化 `RemoteClient` 并尝试连接。
    *   连接成功后，聊天输入不再调用本地 `AgentSession`，而是通过 `RemoteClient.send_message` 发送。
    *   处理 WebSocket 返回的流式消息，并更新 UI 显示。

### 第四阶段：部署与测试
1.  **启动服务**：
    *   在服务器运行：`python -m uvicorn .remote_chat.server.server_app:app --host 0.0.0.0 --port 8000`
2.  **联调测试**：
    *   本地切换至云端模式，发送“你好”，确认收到云端回复。
    *   检查服务器端的 `core_chat_memory.json` 是否更新。
    *   测试断网重连机制。

## 4. 注意事项
*   **安全性**：云端部署必须考虑安全。建议在 `config.json` 中设置复杂的 `auth_token`，并在 WebSocket 连接时校验。
*   **路径问题**：代码中涉及文件路径的地方（如 `os.path.abspath(__file__)`），在云端和本地目录结构不同时可能会报错。请确保所有路径都是基于 `project_root` 的相对路径。
*   **依赖库**：如果使用了特定于 Windows 的库（如 `pywin32`），在 Linux 服务器部署时需要做兼容处理或移除。

## 5. 待办任务清单 (Todo)
- [ ] 服务器环境搭建 (Python, Pip)
- [ ] 提取并整理 `requirements.txt`
- [ ] 改造 `server_app.py` 接入 AgentSession
- [ ] 改造 `client_app.py` 支持流式接收和数据同步
- [ ] UI 层增加模式切换开关
- [ ] 编写自动部署脚本 (Optional)
